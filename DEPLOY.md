# Инструкция по деплою проекта на GitHub и тестовый сервер

## Содержание

1. [Подготовка к деплою](#подготовка-к-деплою)
   - [Инициализация Git и push на GitHub](#1-инициализация-git-репозитория-и-push-на-github)
   - [Проверка .gitignore](#2-проверка-gitignore)
   - [Создание SSH ключа для деплоя](#3-создание-ssh-ключа-для-деплоя-если-нет)
2. [Настройка GitHub Secrets](#настройка-github-secrets)
3. [Экспорт базы данных из OSPanel](#экспорт-базы-данных-из-ospanel)
4. [Импорт базы данных на тестовый сервер](#импорт-базы-данных-на-тестовый-сервер)
5. [Настройка конфигурации на сервере](#настройка-конфигурации-на-сервере)
6. [Автоматический деплой](#автоматический-деплой)
7. [Ручной деплой](#ручной-деплой)

## Подготовка к деплою

### 1. Инициализация Git репозитория и push на GitHub

Если проект еще не подключен к GitHub:

#### Шаг 1: Инициализация Git репозитория

```bash
# Перейдите в директорию проекта
cd /c/OSPanel/home/cost-calc.loc/public

# Инициализируйте git репозиторий
git init

# Добавьте все файлы (кроме тех, что в .gitignore)
git add .

# Создайте первый коммит
git commit -m "Initial commit: калькулятор себестоимости"
```

#### Шаг 2: Подключение к удаленному репозиторию GitHub

```bash
# Добавьте remote репозиторий
git remote add origin https://github.com/DScrepter/grafit-calc.git

# Или если используете SSH (рекомендуется):
# git remote add origin git@github.com:DScrepter/grafit-calc.git

# Проверьте подключение
git remote -v
```

#### Шаг 3: Push проекта на GitHub

```bash
# Переименуйте ветку в main (если нужно)
git branch -M main

# Запушьте код на GitHub
git push -u origin main
```

Если возникнет ошибка аутентификации:

**Вариант 1: Использование Personal Access Token (PAT)**
1. Перейдите в GitHub → Settings → Developer settings → Personal access tokens → Tokens (classic)
2. Создайте новый token с правами `repo`
3. Используйте token вместо пароля при push:
   ```bash
   git push -u origin main
   # Username: ваш_логин_github
   # Password: ваш_personal_access_token
   ```

**Вариант 2: Использование SSH ключа для GitHub**
1. Создайте SSH ключ для GitHub (если еще нет):
   ```bash
   ssh-keygen -t ed25519 -C "your_email@example.com" -f ~/.ssh/github_key
   ```
2. Добавьте публичный ключ в GitHub: Settings → SSH and GPG keys → New SSH key
3. Измените remote на SSH:
   ```bash
   git remote set-url origin git@github.com:DScrepter/grafit-calc.git
   git push -u origin main
   ```

**Вариант 3: Использование GitHub CLI**
```bash
# Установите GitHub CLI (если нет)
# Затем авторизуйтесь
gh auth login

# Push будет работать автоматически
git push -u origin main
```

#### Проверка

После успешного push откройте https://github.com/DScrepter/grafit-calc и убедитесь, что все файлы загружены.

### 2. Проверка .gitignore

Убедитесь, что файлы с конфиденциальными данными не попадут в репозиторий:

- `config/config.php` - должен быть в `.gitignore`
- `backend/config/config.php` - должен быть в `.gitignore`
- `logs/` - директория с логами должна быть в `.gitignore`

Проверьте перед первым коммитом:
```bash
git status
# Убедитесь, что config/config.php не показывается в списке файлов для коммита
```

### 3. Создание SSH ключа для деплоя (если нет)

Если у вас еще нет SSH ключа для деплоя, создайте его:

```bash
ssh-keygen -t ed25519 -C "deploy@cost-calc" -f ~/.ssh/deploy_key
```

Или используйте существующий ключ.

### 3. Добавление публичного ключа на тестовый сервер

#### Для reg.ru хостинга:

На reg.ru обычно SSH доступ уже настроен через панель управления. Проверьте:

1. Войдите в панель управления reg.ru
2. Перейдите в раздел **SSH доступ** или **Терминал**
3. Убедитесь, что SSH доступ включен
4. Если нужно, сгенерируйте SSH ключ через панель или используйте свой

**Вариант 1:** Если reg.ru позволяет добавлять свои SSH ключи:

```bash
# Скопируйте публичный ключ
ssh-copy-id -i ~/.ssh/deploy_key.pub ваш_логин@ваш_домен.reg.ru
```

**Вариант 2:** Если reg.ru использует свой механизм авторизации:

1. Войдите в панель управления reg.ru
2. Найдите раздел **SSH ключи** или **Авторизация**
3. Добавьте содержимое вашего `~/.ssh/deploy_key.pub`
4. Или используйте парольную авторизацию (менее безопасно, но проще)

**Проверка SSH доступа:**

```bash
# Проверьте подключение
ssh ваш_логин@ваш_домен.reg.ru

# Если подключение успешно, вы увидите приглашение командной строки
# Проверьте текущий путь
pwd
```

#### Для обычного VPS/выделенного сервера:

Скопируйте публичный ключ на тестовый сервер:

```bash
ssh-copy-id -i ~/.ssh/deploy_key.pub user@your-server.com
```

Или вручную добавьте содержимое `~/.ssh/deploy_key.pub` в файл `~/.ssh/authorized_keys` на сервере.

## Настройка GitHub Secrets

1. Перейдите в настройки вашего репозитория на GitHub
2. Откройте раздел **Settings** → **Secrets and variables** → **Actions**
3. Нажмите **New repository secret** и добавьте следующие секреты:

### Обязательные секреты:

- **`DEPLOY_HOST`** - IP адрес или домен тестового сервера
  - Пример: `192.168.1.100` или `test.example.com`
  - Для reg.ru: обычно это ваш домен или IP сервера из панели управления

- **`DEPLOY_USER`** - SSH пользователь для подключения к серверу
  - Пример: `deploy` или `www-data`
  - Для reg.ru: обычно это ваш логин от хостинга (например `u1234567`)

- **`DEPLOY_SSH_KEY`** - Приватный SSH ключ (содержимое файла `~/.ssh/deploy_key`)
  - Скопируйте весь ключ включая строки `-----BEGIN ... KEY-----` и `-----END ... KEY-----`

- **`DEPLOY_PATH`** - Полный путь на сервере куда деплоить проект
  - Пример: `/var/www/cost-calc` или `/home/user/cost-calc`
  - **Для reg.ru:** см. раздел [Определение пути на reg.ru](#определение-пути-на-regru) ниже

### Определение пути на reg.ru

На reg.ru хостинге структура директорий обычно такая:

```
/home/uXXXXXX/domains/domain.com/public_html
```

где `uXXXXXX` - ваш пользователь (логин от хостинга).

#### Способ 1: Через SSH

Подключитесь к серверу и проверьте структуру:

```bash
# Подключитесь к серверу
ssh ваш_логин@ваш_домен.reg.ru

# Проверьте текущую директорию
pwd

# Посмотрите структуру
ls -la ~
ls -la ~/domains/  # если есть такая директория
```

#### Способ 2: Использование скрипта

Используйте созданный скрипт для проверки:

```bash
bash scripts/check-regru-path.sh ваш_логин@ваш_домен.reg.ru
```

#### Способ 3: Через панель управления reg.ru

1. Войдите в панель управления reg.ru
2. Перейдите в раздел **Файловый менеджер** или **FTP**
3. Посмотрите путь к `public_html` вашего домена/поддомена
4. Обычно путь выглядит как: `/home/uXXXXXX/domains/ваш-домен.ru/public_html`

#### Варианты путей для reg.ru:

- **Основной домен:** `/home/uXXXXXX/domains/domain.com/public_html`
- **Поддомен:** `/home/uXXXXXX/domains/subdomain.domain.com/public_html`
- **Тестовый поддомен:** `/home/uXXXXXX/domains/test.domain.com/public_html`

**Важно:** Если вы хотите разместить проект в поддиректории (например `/public_html/cost-calc`), путь будет:
```
/home/uXXXXXX/domains/domain.com/public_html/cost-calc
```

### Опциональные секреты:

- **`DEPLOY_DB_HOST`** - Хост базы данных на тестовом сервере (если отличается от localhost)

## Экспорт базы данных из OSPanel

### Способ 1: Использование скрипта export-db.sh

```bash
# В Git Bash или WSL
cd /c/OSPanel/home/cost-calc.loc/public

# Установите переменные окружения (опционально, если отличаются от дефолтных)
export DB_HOST="MySQL-8.2"
export DB_USER="root"
export DB_PASS=""
export DB_NAME="cost_calculator_web"

# Запустите скрипт
bash scripts/export-db.sh database/dump_$(date +%Y%m%d).sql
```

### Способ 2: Использование PHP скрипта dump-db.php

```bash
# В командной строке OSPanel или Git Bash
php scripts/dump-db.php database/dump_latest.sql
```

Скрипт автоматически использует настройки из `config/config.php`.

### Способ 3: Через phpMyAdmin

1. Откройте phpMyAdmin в OSPanel
2. Выберите базу данных `cost_calculator_web`
3. Перейдите на вкладку **Экспорт**
4. Выберите метод **Быстрый** или **Настраиваемый**
5. Нажмите **Вперед** и сохраните SQL файл

### Способ 4: Через командную строку MySQL

```bash
# В командной строке Windows (cmd)
cd C:\OSPanel\modules\database\MySQL-8.2\bin
mysqldump.exe -u root -p cost_calculator_web > C:\OSPanel\home\cost-calc.loc\public\database\dump.sql
```

## Импорт базы данных на тестовый сервер

### Для reg.ru хостинга:

На reg.ru база данных обычно создается через панель управления:

1. Войдите в панель управления reg.ru
2. Перейдите в раздел **Базы данных MySQL**
3. Создайте новую базу данных (запомните имя, пользователя и пароль)
4. Импортируйте дамп через **phpMyAdmin** (см. Способ 3 ниже)

**Важно:** Параметры подключения к БД на reg.ru обычно:
- Хост: `localhost` или специальный хост из панели (например `mysql.reg.ru`)
- Имя БД: обычно в формате `uXXXXXX_dbname`
- Пользователь: обычно в формате `uXXXXXX_dbuser`
- Пароль: тот, что вы задали при создании БД

### Способ 1: Использование скрипта import-db.sh

```bash
# На вашем локальном компьютере
bash scripts/import-db.sh database/dump_latest.sql user@your-server.com /var/www/cost-calc
```

Скрипт автоматически:
- Скопирует SQL файл на сервер
- Импортирует его в базу данных
- Удалит временный файл

**Важно:** Перед импортом убедитесь, что на сервере:
- Создана база данных `cost_calculator_web`
- Настроены переменные окружения `DB_HOST`, `DB_USER`, `DB_PASS`, `DB_NAME` (или используйте дефолтные значения)

### Способ 2: Ручной импорт через SSH

```bash
# Копируем файл на сервер
scp database/dump_latest.sql user@your-server.com:/tmp/

# Подключаемся к серверу
ssh user@your-server.com

# Импортируем БД
mysql -u root -p cost_calculator_web < /tmp/dump_latest.sql

# Удаляем временный файл
rm /tmp/dump_latest.sql
```

### Способ 3: Через phpMyAdmin на сервере (рекомендуется для reg.ru)

1. Войдите в панель управления reg.ru
2. Откройте **phpMyAdmin** (обычно в разделе "Базы данных")
3. Выберите базу данных, которую вы создали
4. Перейдите на вкладку **Импорт**
5. Нажмите **Выберите файл** и загрузите ваш SQL дамп
6. Убедитесь, что выбрана правильная кодировка (обычно `utf8mb4_unicode_ci`)
7. Нажмите **Вперед** и дождитесь завершения импорта

## Настройка конфигурации на сервере

После первого деплоя нужно создать файл конфигурации на сервере:

```bash
# Подключаемся к серверу
ssh user@your-server.com

# Переходим в директорию проекта
cd /var/www/cost-calc  # или ваш DEPLOY_PATH

# Копируем шаблон конфигурации
cp config/config.example.php config/config.php

# Редактируем конфигурацию
nano config/config.php  # или используйте другой редактор
```

Укажите правильные параметры подключения к базе данных на тестовом сервере:

```php
return [
	'database' => [
		'host' => 'localhost',  // или IP адрес БД
		'port' => 3306,
		'dbname' => 'cost_calculator_web',
		'username' => 'your_db_user',
		'password' => 'your_db_password',
		'charset' => 'utf8mb4'
	],
	// ... остальные настройки
];
```

Также создайте конфигурацию для backend (если используется отдельно):

```bash
cp backend/config/config.example.php backend/config/config.php
# Отредактируйте файл аналогично
```

## Автоматический деплой

После настройки GitHub Secrets деплой будет происходить автоматически при каждом push в ветку `main` или `master`.

### Процесс автоматического деплоя:

1. Вы делаете изменения в коде
2. Коммитите и пушите в GitHub:
   ```bash
   git add .
   git commit -m "Описание изменений"
   git push origin main
   ```
3. GitHub Actions автоматически:
   - Проверяет код
   - Подключается к серверу по SSH
   - Копирует файлы на сервер
   - Устанавливает права доступа

### Проверка статуса деплоя:

1. Перейдите на вкладку **Actions** в вашем репозитории GitHub
2. Выберите последний workflow run
3. Проверьте логи выполнения

### Ручной запуск деплоя:

Если нужно запустить деплой вручную:

1. Перейдите на вкладку **Actions**
2. Выберите workflow **Deploy to Test Server**
3. Нажмите **Run workflow**
4. Выберите ветку и нажмите **Run workflow**

## Ручной деплой

Если автоматический деплой не работает или нужно задеплоить вручную:

### Способ 1: Через rsync

```bash
rsync -avz --delete \
	--exclude '.git' \
	--exclude 'logs' \
	--exclude 'config/config.php' \
	--exclude 'backend/config/config.php' \
	./ user@your-server.com:/var/www/cost-calc/
```

### Способ 2: Через git на сервере

```bash
# Подключаемся к серверу
ssh user@your-server.com

# Переходим в директорию проекта
cd /var/www/cost-calc

# Обновляем код
git pull origin main

# Устанавливаем права доступа
find . -type f -exec chmod 644 {} \;
find . -type d -exec chmod 755 {} \;
```

## Особенности работы с reg.ru хостингом

### Ограничения reg.ru:

1. **Ограниченный SSH доступ:** На shared хостинге могут быть ограничения на некоторые команды
2. **Путь к файлам:** Обычно файлы должны быть в `public_html` или его поддиректориях
3. **База данных:** Обычно БД создается через панель управления, не через командную строку
4. **Права доступа:** Некоторые команды `chmod` могут быть ограничены

### Рекомендации для reg.ru:

1. **Используйте поддиректорию:** Если у вас уже есть сайт, разместите проект в поддиректории:
   ```
   /home/uXXXXXX/domains/domain.com/public_html/cost-calc
   ```

2. **База данных:** Создайте БД через панель управления reg.ru, затем импортируйте дамп через phpMyAdmin

3. **Проверка путей:** Всегда проверяйте путь через SSH перед настройкой деплоя:
   ```bash
   ssh ваш_логин@ваш_домен.reg.ru
   pwd
   ls -la
   ```

4. **Альтернатива rsync:** Если `rsync` недоступен на reg.ru, можно использовать `scp` или адаптировать workflow

## Устранение проблем

### Проблема: SSH подключение не работает

**Решение:**
- Проверьте, что SSH доступ включен в панели управления reg.ru
- Проверьте правильность `DEPLOY_HOST` и `DEPLOY_USER` в GitHub Secrets
- Для reg.ru используйте формат: `ваш_логин@ваш_домен.reg.ru` или IP адрес сервера
- Проверьте, что приватный ключ в `DEPLOY_SSH_KEY` скопирован полностью

### Проблема: Файлы не копируются

**Решение:**
- Проверьте права доступа на директорию `DEPLOY_PATH` на сервере
- Убедитесь, что пользователь `DEPLOY_USER` имеет права на запись

### Проблема: База данных не подключается после деплоя

**Решение:**
- Проверьте, что файл `config/config.php` создан на сервере
- Проверьте правильность параметров подключения к БД
- Убедитесь, что база данных импортирована

### Проблема: Ошибки прав доступа

**Решение:**
После деплоя выполните на сервере:

```bash
cd /var/www/cost-calc  # ваш DEPLOY_PATH
find . -type f -exec chmod 644 {} \;
find . -type d -exec chmod 755 {} \;
chmod 755 logs  # если директория существует
```

## Дополнительные настройки

### Настройка веб-сервера

Убедитесь, что веб-сервер (Apache/Nginx) настроен правильно:

- Указан правильный `DocumentRoot` на `DEPLOY_PATH`
- Включен `mod_rewrite` (для Apache)
- Настроены правильные права доступа

### Настройка cron задач (если нужно)

Если в проекте есть cron задачи, добавьте их на сервере:

```bash
crontab -e
```

### Мониторинг логов

Логи приложения находятся в директории `logs/` на сервере. Проверяйте их при возникновении проблем.

## Контакты и поддержка

При возникновении проблем проверьте:
1. Логи GitHub Actions
2. Логи приложения на сервере (`logs/error-*.log`)
3. Логи веб-сервера
