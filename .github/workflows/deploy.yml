name: Deploy to Test Server

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install sshpass
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq sshpass
      
      - name: Deploy to server
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
          DEPLOY_PASSWORD: ${{ secrets.DEPLOY_PASSWORD }}
        run: |
          # Функция для SSH команды
          ssh_cmd() {
            sshpass -p "${DEPLOY_PASSWORD}" ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ${DEPLOY_USER}@${DEPLOY_HOST} "$@"
          }
          
          # Функция для rsync
          rsync_cmd() {
            sshpass -p "${DEPLOY_PASSWORD}" rsync -avz \
              --exclude '.git' \
              --exclude '.github' \
              --exclude 'node_modules' \
              --exclude 'logs' \
              --exclude '*.log' \
              --exclude 'config/config.php' \
              --exclude 'backend/config/config.php' \
              --exclude '.DS_Store' \
              --exclude 'Thumbs.db' \
              --no-owner \
              --no-group \
              --checksum \
              -e "ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR" \
              ./ ${DEPLOY_USER}@${DEPLOY_HOST}:${DEPLOY_PATH}/
          }
          
          # Тест подключения
          echo "Testing SSH connection..."
          ssh_cmd "echo 'SSH connection successful'" || {
            echo "SSH connection failed. Please check:"
            echo "1. DEPLOY_HOST, DEPLOY_USER are correct"
            echo "2. DEPLOY_PASSWORD is correct"
            echo "3. Server allows SSH connections from GitHub Actions IPs"
            exit 1
          }
          
          # Проверяем существование директории и права доступа
          echo "Checking deployment directory..."
          ssh_cmd "test -d ${DEPLOY_PATH} && echo 'Directory exists' || (echo 'Directory does not exist: ${DEPLOY_PATH}' && exit 1)" || {
            echo "ERROR: Directory ${DEPLOY_PATH} does not exist or is not accessible"
            echo "Please create it manually on the server or check the DEPLOY_PATH secret"
            exit 1
          }
          
          # Проверяем права на запись
          ssh_cmd "test -w ${DEPLOY_PATH} && echo 'Directory is writable' || (echo 'Directory is not writable: ${DEPLOY_PATH}' && exit 1)" || {
            echo "ERROR: No write permission to ${DEPLOY_PATH}"
            echo "Please check permissions on the server"
            exit 1
          }
          
          # Копируем файлы на сервер
          echo "Copying files to server..."
          rsync_cmd
          
          # Устанавливаем права доступа только для новых/измененных файлов и скриптов
          echo "Setting file permissions..."
          ssh_cmd "cd ${DEPLOY_PATH} && \
            find . -type f ! -perm 644 -exec chmod 644 {} \; && \
            find . -type d ! -perm 755 -exec chmod 755 {} \; && \
            find . -name '*.sh' -exec chmod 755 {} \; && \
            ([ -d 'logs' ] && chmod 755 logs || true) && \
            echo 'Deployment completed successfully!'"
