# Рефакторинг проекта - Упрощение архитектуры

## Проблемы, которые были решены

### 1. Гибридная архитектура
**Было:** Смесь SPA (calculator.php) и традиционных PHP страниц (reference/*.php)
**Стало:** Единый SPA подход через calculator.php с роутером

### 2. Дублирование логики авторизации
**Было:** Проверка прав в PHP и в JS (auth.js, app.js)
**Стало:** Единая проверка в router.js

### 3. Разные подходы к навигации
**Было:** calculator через SPA, reference через обычные переходы
**Стало:** Все страницы через единый роутер

### 4. Сложная логика Assets
**Было:** Разные base_path для разных страниц ('', '../')
**Стало:** Единый корневой путь

### 5. Дублирование sidebar
**Было:** Разная логика для calculator и reference
**Стало:** Единая логика для всех страниц

### 6. Сложное определение API_BASE
**Было:** Динамическое вычисление пути в зависимости от location.pathname
**Стало:** Единый путь '/backend/api'

## Изменения в файлах

### Созданные файлы
- `frontend/js/router.js` - единый роутер для SPA

### Удаленные файлы
- `reference/materials.php`
- `reference/operations.php`
- `reference/units.php`
- `reference/product_types.php`
- `reference/coefficients.php`
- `frontend/js/navigation.js` (заменен router.js)
- `frontend/js/auth.js` (логика перенесена в router.js)

### Измененные файлы
- `frontend/js/app.js` - упрощен, использует router
- `frontend/js/api.js` - упрощено определение API_BASE
- `backend/classes/Assets.php` - убрана логика base_path
- `templates/sidebar.php` - единая логика для всех страниц
- `calculator.php` - теперь используется для всех страниц
- `.htaccess` - редирект reference страниц на calculator

## Новая архитектура

### Роутинг
Все страницы теперь доступны через:
- `/calculator` - главная страница
- `/calculator?page=materials` - материалы
- `/calculator?page=operations` - операции
- `/calculator?page=units` - единицы измерения
- `/calculator?page=product_types` - типы изделий
- `/calculator?page=coefficients` - коэффициенты
- `/calculator?page=users` - пользователи (только для админов)

Старые URL `/reference/*` автоматически редиректятся на `/calculator?page=*`

### Проверка прав доступа
- Проверка авторизации в router.js
- Проверка ролей в router.js
- Гости автоматически перенаправляются на /profile

### Навигация
- Все ссылки обрабатываются роутером
- History API для навигации без перезагрузки
- Автоматическое обновление активного пункта меню

## Преимущества

1. **Упрощение поддержки** - единая точка входа для всех страниц
2. **Меньше дублирования** - одна логика вместо нескольких
3. **Быстрая навигация** - без перезагрузки страницы
4. **Проще добавлять новые страницы** - просто регистрируем в router
5. **Единая проверка прав** - в одном месте

## Обратная совместимость

Старые URL `/reference/*` автоматически редиректятся на новые через .htaccess.
Все существующие JS модули страниц (MaterialsPage, OperationsPage и т.д.) работают без изменений.
